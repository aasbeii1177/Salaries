<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Salary & Attendance Master</title>
  
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4f46e5">
  <meta name="apple-mobile-web-app-capable" content="yes">
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&family=Noto+Sans+Arabic:wght@400;700;900&display=swap" rel="stylesheet">
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #000; -webkit-tap-highlight-color: transparent; }
    .font-arabic { font-family: 'Noto Sans Arabic', sans-serif; }
    input, select, textarea { color: #000 !important; font-weight: 700 !important; }
    input:focus, select:focus { border-color: #4f46e5 !important; box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1) !important; background-color: #fff !important; }
    ::placeholder { color: #6b7280 !important; font-weight: 400 !important; }
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    // --- 1. FIREBASE INIT ---
    const firebaseConfig = {
      apiKey: "AIzaSyAcnI1SduIdCVNKOZWcdSB2FFrGAkAXf8o",
      authDomain: "unisalaries.firebaseapp.com",
      projectId: "unisalaries",
      storageBucket: "unisalaries.firebasestorage.app",
      messagingSenderId: "503777169975",
      appId: "1:503777169975:web:96dfda7bca9f8f552fa5b2"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- 2. DATA CONSTANTS & TRANSLATIONS ---
    const translations = {
      appTitle: { en: "SalaryMaster", ar: "ماستر الرواتب" },
      subTitle: { en: "Enterprise Workforce Operations", ar: "عمليات القوى العاملة للمؤسسات" },
      signOut: { en: "Sign Out", ar: "تسجيل الخروج" },
      username: { en: "Username", ar: "اسم المستخدم" },
      password: { en: "Password", ar: "كلمة السر" },
      login: { en: "Authorize Access", ar: "تصريح الدخول" },
      loginTitle: { en: "Enterprise Payroll Access", ar: "الوصول إلى كشوف المرتبات" },
      owner: { en: "Owner", ar: "المالك" },
      hr: { en: "HR / Admin", ar: "الموارد البشرية" },
      manager: { en: "Manager", ar: "المدير" },
      finance: { en: "Finance", ar: "المالية" },
      data_entry: { en: "Data Entry", ar: "مدخل بيانات" },
      workers: { en: "Worker Ledger", ar: "سجل العمال" },
      sections: { en: "Manage Sections", ar: "إدارة الأقسام" },
      attendance: { en: "Attendance", ar: "التحضير" },
      attendanceLogs: { en: "Attendance Logs", ar: "سجلات الحضور" },
      dailyLogs: { en: "Daily Logs", ar: "السجلات اليومية" },
      payroll: { en: "Payroll", ar: "الرواتب" },
      userAccess: { en: "User Access", ar: "صلاحيات المستخدمين" },
      name: { en: "Full Name", ar: "الاسم الكامل" },
      wage: { en: "Monthly Wage", ar: "الراتب الشهري" },
      shift: { en: "Shift", ar: "الوردية" },
      day: { en: "Day", ar: "صباحي" },
      night: { en: "Night", ar: "مسائي" },
      joinDate: { en: "Join Date", ar: "تاريخ الانضمام" },
      save: { en: "Save", ar: "حفظ" },
      edit: { en: "Edit", ar: "تعديل" },
      delete: { en: "Delete", ar: "حذف" },
      add: { en: "Add", ar: "إضافة" },
      cancel: { en: "Cancel", ar: "إلغاء" },
      search: { en: "Search...", ar: "بحث..." },
      total: { en: "Total", ar: "الإجمالي" },
      present: { en: "Present", ar: "حاضر" },
      absent: { en: "Absent", ar: "غائب" },
      advance: { en: "Advance", ar: "سلفة" },
      advances: { en: "Advances", ar: "السلف" },
      bonus: { en: "Bonus", ar: "مكافأة" },
      loan: { en: "Loan", ar: "قرض" },
      transport: { en: "Fixed Transport", ar: "المواصلات الثابتة" },
      overtime: { en: "Overtime", ar: "الإضافي" },
      resigned: { en: "Resigned", ar: "مستقيل" },
      active: { en: "Active", ar: "نشط" },
      confirm: { en: "Confirm", ar: "تأكيد" },
      locked: { en: "Locked", ar: "مغلق" },
      generatePdf: { en: "Export Global Payslips", ar: "تصدير كشوف المرتبات" },
      exportCsv: { en: "Export Report (Excel)", ar: "تصدير تقرير (إكسل)" },
      strategicControl: { en: "Strategic Control", ar: "التحكم الاستراتيجي" },
      systemLogic: { en: "System Logic", ar: "منطق النظام" },
      periods: { en: "Periods", ar: "الفترات" },
      bonusCenter: { en: "Bonus Center", ar: "مركز المكافآت" },
      credentialManagement: { en: "Credential Management", ar: "إدارة البيانات" },
      liabilityOversight: { en: "Liability Oversight", ar: "الرقابة المالية" },
      recoveryVelocity: { en: "Recovery Velocity", ar: "سرعة التحصيل" },
      netEstimate: { en: "Net Estimate", ar: "صافي التقدير" },
      workerDetails: { en: "Worker Information", ar: "بيانات العامل" },
      section: { en: "Section", ar: "القسم" },
      nationalId: { en: "National ID", ar: "الرقم الوطني" },
      insuranceId: { en: "Insurance No.", ar: "رقم التأمين" },
      fatherName: { en: "Father's Name", ar: "اسم الأب" },
      motherName: { en: "Mother's Name", ar: "اسم الأم" },
      dob: { en: "Date of Birth", ar: "تاريخ الميلاد" },
      syp: { en: "SYP", ar: "ل.س" },
      unassigned: { en: "Unassigned Workers", ar: "عمال غير مصنفين" },
      noWorkersInSection: { en: "No workers in this section.", ar: "لا يوجد عمال في هذا القسم." },
      resignWorker: { en: "Resign Worker", ar: "استقالة عامل" },
      archiveConfirm: { en: "Archive profile for", ar: "أرشفة ملف" },
      eraseConfirm: { en: "Erase all records for", ar: "مسح جميع سجلات" },
      opsHub: { en: "Daily Operations Hub", ar: "مركز العمليات اليومي" },
      recordingFor: { en: "Recording for", ar: "تسجيل لـ" },
      opsDate: { en: "Operation Date", ar: "تاريخ العملية" },
      resetList: { en: "Reset List", ar: "إعادة تعيين القائمة" },
      verified: { en: "Attendance Verified for this Day", ar: "تم التحقق من الحضور لهذا اليوم" },
      notLogged: { en: "Attendance Not Yet Logged", ar: "الحضور لم يسجل بعد" },
      verifiedSub: { en: "Record stored: workers were absent.", ar: "تم الحفظ: العمال كانوا غائبين." },
      notLoggedSub: { en: "Click to confirm that everyone present is recorded.", ar: "انقر للتأكيد أن الجميع حاضر ما عدا المحددين." },
      verifyLog: { en: "Verify & Log Attendance", ar: "التحقق وتسجيل الحضور" },
      updateLog: { en: "Update Daily Log", ar: "تحديث السجل اليومي" },
      activitySummary: { en: "Activity Summary", ar: "ملخص النشاط" },
      historyProtected: { en: "Payroll History Protected", ar: "سجل الرواتب محمي" },
      noActivity: { en: "No activity for this date.", ar: "لا يوجد نشاط لهذا التاريخ." },
      debtLedger: { en: "Workforce Debt Ledger", ar: "سجل ديون العمال" },
      remainingDebt: { en: "Remaining Debt", ar: "الدين المتبقي" },
      periodExtras: { en: "Period Extras", ar: "إضافات الفترة" },
      actions: { en: "Actions", ar: "إجراءات" },
      contractId: { en: "Contract ID", ar: "رقم العقد" },
      debtFree: { en: "Debt-Free", ar: "بدون ديون" },
      issueLoan: { en: "Issue Loan", ar: "إصدار قرض" },
      editContract: { en: "Edit Contract", ar: "تعديل العقد" },
      logicSync: { en: "Global logic variables successfully synchronized.", ar: "تمت مزامنة متغيرات المنطق العالمية بنجاح." },
      bonusEngine: { en: "Bonus Distribution Engine", ar: "محرك توزيع المكافآت" },
      fixedAmount: { en: "Fixed Amount", ar: "مبلغ ثابت" },
      percentWage: { en: "% of Wage", ar: "نسبة من الراتب" },
      beneficiaries: { en: "Beneficiaries", ar: "المستفيدين" },
      distributeCapital: { en: "Distribute Bonus Capital", ar: "توزيع رأس مال المكافآت" },
      unauthorized: { en: "Unauthorized Access Role", ar: "دور وصول غير مصرح به" },
      logHours: { en: "Log Hours", ar: "تسجيل الساعات" },
      hrs: { en: "Hrs", ar: "ساعة" },
      daysPerMonth: { en: "Days / Month", ar: "أيام العمل / شهر" },
      hoursPerDay: { en: "Hours / Day", ar: "ساعات العمل / يوم" },
      otFactor: { en: "Overtime Factor (x)", ar: "عامل الإضافي (x)" },
      absencePenalty: { en: "Absence Penalty (x)", ar: "عامل الغياب (x)" },
      nightMultiplier: { en: "Night Shift Multiplier (Premium)", ar: "مضاعف الوردية الليلية" },
      nightExplainer: { en: "Factor 1.2 = Night workers take 20% extra pay.", ar: "عامل 1.2 يعني زيادة 20% لعمال الليل." },
      commitLogic: { en: "Commit Logic Updates", ar: "تثبيت تحديثات المنطق" },
      realTimeLogic: { en: "Real-Time Logic Preview", ar: "معاينة المنطق المباشرة" },
      dayRate: { en: "Day Rate", ar: "أجرة اليوم" },
      nightRate: { en: "Night Rate", ar: "أجرة الليل" },
      absenceCut: { en: "Absence Cut", ar: "خصم الغياب" },
      otPerHour: { en: "OT / Hour", ar: "الإضافي بالساعة" },
      payrollPeriods: { en: "Payroll Periods", ar: "فترات الرواتب" },
      lockFinalized: { en: "Lock finalized months to prevent edits", ar: "إغلاق الأشهر المنتهية لمنع التعديل" },
      closedLocked: { en: "Closed & Locked", ar: "مغلق ومحمي" },
      openForEdits: { en: "Open for Edits", ar: "مفتوح للتعديل" },
      quarterlyIncentive: { en: "Quarterly Incentive", ar: "حافز ربع سنوي" },
      distributionLogs: { en: "Distribution Logs", ar: "سجلات التوزيع" },
      former: { en: "Former", ar: "سابق" },
      createAccess: { en: "Create Access", ar: "إنشاء وصول" },
      updateIdentity: { en: "Update Identity", ar: "تحديث الهوية" },
      cancelEdit: { en: "Cancel Edit", ar: "إلغاء التعديل" },
      authorizeIdentity: { en: "Authorize Identity", ar: "تخويل الهوية" },
      commit: { en: "Commit", ar: "تثبيت" },
      operationalRole: { en: "Operational Role", ar: "الدور العملياتي" },
      secretKey: { en: "Secret Key", ar: "كلمة السر" },
      liabilityContract: { en: "Liability Contract", ar: "عقد التزام" },
      managingProfile: { en: "Managing profile for", ar: "إدارة ملف" },
      impactPerCycle: { en: "Impact Per Cycle", ar: "التأثير لكل دورة" },
      discard: { en: "Discard", ar: "تجاهل" },
      saveContract: { en: "Save Contract", ar: "حفظ العقد" },
      outstandingPortfolio: { en: "Outstanding Portfolio Value", ar: "إجمالي قيمة القروض" },
      activeDebtors: { en: "Active Debtors", ar: "المدينون النشطون" },
      monthlyRecovery: { en: "Monthly Recovery Projection", ar: "توقع التحصيل الشهري" },
      debtLedgerTitle: { en: "Workforce Debt Ledger", ar: "سجل ديون القوى العاملة" },
      employeeInfo: { en: "Employee Info", ar: "معلومات الموظف" },
      systemVariables: { en: "System Variables", ar: "متغيرات النظام" },
      allActive: { en: "All Active Employees", ar: "جميع الموظفين النشطين" },
      individual: { en: "Individual", ar: "فردي" },
      target: { en: "Target", ar: "الهدف" },
      distType: { en: "Distribution Type", ar: "نوع التوزيع" },
      saveAll: { en: "Save All", ar: "حفظ الكل" },
      logged: { en: "Logged", ar: "مسجل" },
      finalizeLock: { en: "Finalize & Lock", ar: "إغلاق وتثبيت" },
      lockedByOwner: { en: "Locked by Owner", ar: "مغلق من المالك" },
      actionsLocked: { en: "Actions Locked", ar: "الإجراءات مقفلة" },
      unlockToPrint: { en: "Lock period to print", ar: "أغلق الفترة للطباعة" },
      missing: { en: "Missing", ar: "مفقود" },
      mustBePositive: { en: "Values must be positive", ar: "يجب أن تكون القيم موجبة" },
      editEntries: { en: "Edit Entries", ar: "تعديل المدخلات" }
    };

    // --- 3. SERVICES (PDF) ---
    const generateAllPayslips = async (targetMonth, employees, attendance, advances, overtime, loans, transportation, config, sections, bonuses) => {
      const { jsPDF } = window.jspdf;
      
      const fontUrl = 'https://raw.githubusercontent.com/google/fonts/main/ofl/amiri/Amiri-Regular.ttf';
      const fontBytes = await fetch(fontUrl).then(res => res.arrayBuffer());
      
      let binary = '';
      const bytes = new Uint8Array(fontBytes);
      const len = bytes.byteLength;
      for (let i = 0; i < len; i++) {
        binary += String.fromCharCode(bytes[i]);
      }
      const base64Font = window.btoa(binary);

      const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
      doc.addFileToVFS('Amiri-Regular.ttf', base64Font);
      doc.addFont('Amiri-Regular.ttf', 'Amiri', 'normal');
      doc.setFont('Amiri'); 

      const monthAttendance = attendance.filter(a => a.date.startsWith(targetMonth));
      const monthAdvances = advances.filter(a => a.date.startsWith(targetMonth));
      const monthOvertime = overtime.filter(o => o.date.startsWith(targetMonth));
      const monthBonuses = bonuses.filter(b => b.date.startsWith(targetMonth));
      const monthTransport = transportation.filter(t => t.date.startsWith(targetMonth));

      const totalPotentialDays = monthAttendance.length || 0;

      employees.forEach((emp, index) => {
        if (index !== 0) doc.addPage();
        const sectionName = sections.find(s => s.id === emp.sectionId)?.name || 'GENERAL';
        const isNightShift = emp.shift === 'night';
        const shiftFactor = isNightShift ? (config.nightShiftMultiplier || 1.0) : 1.0;
        const absenceRecords = monthAttendance.filter(a => a.absentEmployeeIds.includes(emp.id));
        const daysAbsent = absenceRecords.length;
        const daysPresent = Math.max(0, totalPotentialDays - daysAbsent);
        const baseDailyRate = emp.monthlyWage / config.daysInMonth;
        const effectiveMonthlyWage = emp.monthlyWage * shiftFactor;
        const totalAbsenceDeduction = daysAbsent * baseDailyRate * config.absentDeductionFactor;
        const effectiveDailyRate = baseDailyRate * shiftFactor;
        const hourlyRate = effectiveDailyRate / config.hoursPerDay;
        const empOvertimeHours = monthOvertime.filter(ot => ot.employeeId === emp.id).reduce((sum, curr) => sum + curr.hours, 0);
        const overtimePay = empOvertimeHours * hourlyRate * config.otMultiplier;
        const empBonus = monthBonuses.filter(b => b.employeeId === emp.id).reduce((sum, curr) => sum + curr.amount, 0);
        const fixedTransportation = emp.transportationAllowance || 0;
        const extraTransportation = monthTransport.filter(t => t.employeeId === emp.id).reduce((sum, curr) => sum + curr.amount, 0);
        const totalTransportation = fixedTransportation + extraTransportation;
        const loan = loans.find(l => l.employeeId === emp.id);
        const loanDeduction = loan ? (loan.totalAmount * (loan.deductionPercentage / 100)) : 0;
        const totalAdvances = monthAdvances.filter(a => a.employeeId === emp.id).reduce((sum, curr) => sum + curr.amount, 0);
        const earnedBasicWages = Math.max(0, effectiveMonthlyWage - totalAbsenceDeduction);
        const totalEarnings = earnedBasicWages + overtimePay + totalTransportation + empBonus;
        const totalDeductions = totalAdvances + loanDeduction;
        const netSalary = Math.max(0, totalEarnings - totalDeductions);

        doc.setFillColor(isNightShift ? 15 : 79, isNightShift ? 23 : 70, isNightShift ? 42 : 229);
        doc.rect(0, 0, 210, 45, 'F');
        doc.setFillColor(255, 255, 255, 0.2);
        doc.roundedRect(170, 10, 25, 25, 5, 5, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(16);
        doc.text(config.logoPlaceholder || 'S|M', 182.5, 26, { align: 'center' });
        doc.setFontSize(22);
        doc.text(config.companyName.toUpperCase(), 20, 25);
        doc.setFontSize(10);
        doc.text(`VOUCHER: ${emp.shift?.toUpperCase() || 'DAY'} SHIFT • ${sectionName.toUpperCase()}`, 20, 34);
        doc.text(`PAY PERIOD: ${targetMonth}`, 115, 25);
        
        doc.setTextColor(30, 30, 30);
        doc.setFontSize(13);
        doc.text('WORKER INFORMATION', 20, 58);
        doc.line(20, 60, 210-20, 60);

        doc.setFontSize(10);
        let infoY = 68;
        doc.text(`Full Name:`, 20, infoY); doc.text(emp.name, 50, infoY);
        doc.text(`Join Date:`, 85, infoY); doc.text(emp.joinDate, 110, infoY);
        doc.text(`Shift:`, 150, infoY); doc.text((emp.shift || 'day').toUpperCase(), 175, infoY);
        
        infoY += 8;
        doc.text(`National ID:`, 20, infoY); doc.text(emp.nationalId || 'N/A', 50, infoY);
        doc.text(`Insurance:`, 85, infoY); doc.text(emp.socialInsuranceId || 'N/A', 110, infoY);

        doc.setFillColor(249, 250, 251);
        doc.roundedRect(20, infoY + 10, 170, 30, 2, 2, 'F');
        doc.setTextColor(31, 41, 55);
        doc.setFontSize(10);
        doc.text(`Summary: ${daysPresent} Present / ${daysAbsent} Absent`, 30, infoY + 22);
        doc.text(`Monthly Wage: ${emp.monthlyWage.toLocaleString()} SYP`, 30, infoY + 30);
        doc.text(`Fixed Transportation: ${fixedTransportation.toLocaleString()} SYP`, 110, infoY + 30);

        doc.setDrawColor(243, 244, 246);
        doc.roundedRect(20, infoY + 50, 170, 95, 3, 3, 'FD');
        doc.setTextColor(30, 30, 30);
        doc.setFontSize(12);
        doc.text('EARNINGS & DEDUCTIONS', 30, infoY + 63);

        doc.setFontSize(10);
        let tableY = infoY + 75;
        doc.text(`Basic Pay:`, 30, tableY); doc.text(`${Math.round(effectiveMonthlyWage).toLocaleString()}`, 180, tableY, { align: 'right' }); tableY += 8;
        doc.setTextColor(239, 68, 68); doc.text(`Penalty:`, 30, tableY); doc.text(`- ${Math.round(totalAbsenceDeduction).toLocaleString()}`, 180, tableY, { align: 'right' }); tableY += 8;
        doc.setTextColor(30, 30, 30); doc.text(`Overtime:`, 30, tableY); doc.text(`${Math.round(overtimePay).toLocaleString()}`, 180, tableY, { align: 'right' }); tableY += 8;
        doc.text(`Transport:`, 30, tableY); doc.text(`${totalTransportation.toLocaleString()}`, 180, tableY, { align: 'right' }); tableY += 8;
        doc.setTextColor(34, 197, 94); doc.text(`Bonus:`, 30, tableY); doc.text(`+ ${empBonus.toLocaleString()}`, 180, tableY, { align: 'right' }); tableY += 8;
        doc.setTextColor(239, 68, 68); doc.text(`Deductions:`, 30, tableY); doc.text(`- ${totalDeductions.toLocaleString()}`, 180, tableY, { align: 'right' });

        doc.setFillColor(isNightShift ? 15 : 79, isNightShift ? 23 : 70, isNightShift ? 42 : 229);
        doc.rect(20, infoY + 130, 170, 15, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(14);
        doc.text('NET PAY:', 30, infoY + 140);
        doc.text(`${Math.round(netSalary).toLocaleString()} SYP`, 180, infoY + 140, { align: 'right' });
      });
      doc.save(`Payslips_${targetMonth}.pdf`);
    };

    // --- 4. DASHBOARD COMPONENTS ---

    const Login = ({ onLogin, users, lang, t, toggleLanguage }) => {
      const [username, setUsername] = React.useState('');
      const [password, setPassword] = React.useState('');
      const [error, setError] = React.useState('');
      const handleSubmit = (e) => {
        e.preventDefault();
        setError('');
        const u = username.toLowerCase().trim();
        const p = password.trim();
        const foundUser = users.find(user => user.username.toLowerCase() === u && user.password === p);
        if (foundUser) { onLogin(foundUser); } else { setError('Invalid identity or secret key. Access denied.'); }
      };
      return (
        <div className={`min-h-screen bg-gradient-to-br from-slate-950 via-indigo-950 to-indigo-900 flex items-center justify-center p-4 ${lang === 'ar' ? 'font-arabic' : ''}`} dir={lang === 'ar' ? 'rtl' : 'ltr'}>
          <div className="absolute top-6 right-6">
            <button onClick={toggleLanguage} className="px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-xl text-xs font-black border border-white/20 uppercase tracking-widest transition-all backdrop-blur-md">{lang === 'en' ? 'العربية' : 'English'}</button>
          </div>
          <div className="bg-white/95 backdrop-blur-sm w-full max-w-md rounded-[2.5rem] shadow-2xl p-10 border border-white/20">
            <div className="text-center mb-10">
              <div className="w-16 h-16 bg-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-xl shadow-indigo-500/30">
                 <svg className="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2.5" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
              </div>
              <h2 className="text-3xl font-black text-black tracking-tight">{t('appTitle')}</h2>
              <p className="text-black font-semibold mt-1 text-sm">{t('loginTitle')}</p>
            </div>
            <form onSubmit={handleSubmit} className="space-y-6">
              <div>
                <label className="block text-[10px] font-black text-black uppercase tracking-[0.2em] ml-1 mb-2">{t('username')}</label>
                <input type="text" required className="w-full px-5 py-4 rounded-2xl bg-white border border-indigo-100 focus:ring-4 focus:ring-indigo-100 focus:border-indigo-600 outline-none transition-all font-black text-black placeholder-gray-400" placeholder={t('username')} value={username} onChange={(e) => setUsername(e.target.value)} />
              </div>
              <div>
                <label className="block text-[10px] font-black text-black uppercase tracking-[0.2em] ml-1 mb-2">{t('password')}</label>
                <input type="password" required className="w-full px-5 py-4 rounded-2xl bg-white border border-indigo-100 focus:ring-4 focus:ring-indigo-100 focus:border-indigo-600 outline-none transition-all font-black text-black placeholder-gray-400" placeholder="••••••••" value={password} onChange={(e) => setPassword(e.target.value)} />
              </div>
              {error && <p className="text-red-600 text-xs font-black text-center bg-red-50 py-3 rounded-xl border border-red-100 animate-pulse">{error}</p>}
              <button type="submit" className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-black py-4 rounded-2xl shadow-xl shadow-indigo-500/20 transform active:scale-[0.98] transition-all uppercase tracking-widest text-xs">{t('login')}</button>
            </form>
          </div>
        </div>
      );
    };

    const HRDashboard = ({ employees, sections, addEmployee, updateEmployee, resignEmployee, deleteEmployee, addSection, updateSection, deleteSection, attendance, advances, overtime, transportation, loans, pdfConfig, setPdfConfig, bonuses, lockedMonths, lockPeriod, lang, t }) => {
      const [formData, setFormData] = React.useState({ name: '', wage: '', transportAllowance: '0', shift: 'day', joinDate: new Date().toISOString().split('T')[0], nationalId: '', socialInsuranceId: '', fatherName: '', motherName: '', dateOfBirth: '', sectionId: '' });
      const [isGenerating, setIsGenerating] = React.useState(false);
      const [searchQuery, setSearchQuery] = React.useState('');
      const [viewResigned, setViewResigned] = React.useState(false);
      const [activeTab, setActiveTab] = React.useState('workers');
      const [newSectionName, setNewSectionName] = React.useState('');
      const [editingId, setEditingId] = React.useState(null);
      const [editFormData, setEditFormData] = React.useState({});
      const [expandedId, setExpandedId] = React.useState(null);
      const [showDeleteModal, setShowDeleteModal] = React.useState(false);
      const [employeeTarget, setEmployeeTarget] = React.useState(null);
      const inputClass = "w-full px-4 py-2.5 border-2 border-gray-300 rounded-xl font-bold bg-white text-black outline-none focus:border-indigo-600 transition-all";

      const filteredEmployees = React.useMemo(() => employees.filter(emp => (viewResigned ? emp.isResigned : !emp.isResigned) && emp.name.toLowerCase().includes(searchQuery.toLowerCase())), [employees, searchQuery, viewResigned]);
      const employeesBySection = React.useMemo(() => {
        const grouped = { 'unassigned': [] };
        sections.forEach(s => grouped[s.id] = []);
        filteredEmployees.forEach(emp => { if (emp.sectionId && grouped[emp.sectionId]) grouped[emp.sectionId].push(emp); else grouped['unassigned'].push(emp); });
        return grouped;
      }, [filteredEmployees, sections]);

      // Calculate recent months for Locking UI (Fixed to include locked months)
      const recentMonths = React.useMemo(() => {
         const dates = attendance.map(a => a.date);
         // Ensure Owner can see locked months even if empty
         const months = [...new Set([...dates.map(d => d.substring(0, 7)), ...lockedMonths])];
         const now = new Date();
         const curr = now.toISOString().substring(0,7);
         if(!months.includes(curr)) months.push(curr);
         return months.sort().reverse();
      }, [attendance, lockedMonths]);

      const handleAdd = (e) => { e.preventDefault(); addEmployee({ ...formData, monthlyWage: parseFloat(formData.wage), transportationAllowance: parseFloat(formData.transportAllowance) || 0, sectionId: formData.sectionId || undefined }); setFormData({ ...formData, name: '', wage: '', nationalId: '', socialInsuranceId: '', fatherName: '', motherName: '' }); };
      const startEditing = (emp) => { setEditingId(emp.id); setEditFormData({ ...emp, wage: emp.monthlyWage, transportAllowance: emp.transportationAllowance }); };
      const handleUpdate = () => { updateEmployee(editingId, { ...editFormData, monthlyWage: parseFloat(editFormData.wage), transportationAllowance: parseFloat(editFormData.transportAllowance) }); setEditingId(null); };
      
      const handleGeneratePDF = async (targetMonth) => { 
         setIsGenerating(true); 
         await generateAllPayslips(targetMonth, employees.filter(e=>!e.isResigned), attendance, advances, overtime, loans, transportation, pdfConfig, sections, bonuses); 
         setIsGenerating(false); 
      };

      const handleExportCSV = (targetMonth) => {
         const headers = ['Name', 'Section', 'Wage', 'Shift', 'Days Absent', 'Penalty Deduction', 'Overtime (Hrs)', 'Overtime (Amt)', 'Bonus', 'Transport', 'Advances', 'Loans', 'Net Salary'];
         // Filter data by target month
         const monthAttendance = attendance.filter(a => a.date.startsWith(targetMonth));
         const monthAdvances = advances.filter(a => a.date.startsWith(targetMonth));
         const monthOvertime = overtime.filter(o => o.date.startsWith(targetMonth));
         const monthBonuses = bonuses.filter(b => b.date.startsWith(targetMonth));
         const monthTransport = transportation.filter(t => t.date.startsWith(targetMonth));
         
         const rows = employees.filter(e => !e.isResigned).map(emp => {
            const sectionName = sections.find(s => s.id === emp.sectionId)?.name || 'GENERAL';
            const isNightShift = emp.shift === 'night';
            const shiftFactor = isNightShift ? (pdfConfig.nightShiftMultiplier || 1.0) : 1.0;
            const absenceRecords = monthAttendance.filter(a => a.absentEmployeeIds.includes(emp.id));
            const daysAbsent = absenceRecords.length;
            const baseDailyRate = emp.monthlyWage / pdfConfig.daysInMonth;
            const effectiveMonthlyWage = emp.monthlyWage * shiftFactor;
            const totalAbsenceDeduction = daysAbsent * baseDailyRate * pdfConfig.absentDeductionFactor;
            const earnedBasicWages = Math.max(0, effectiveMonthlyWage - totalAbsenceDeduction);
            const effectiveDailyRate = baseDailyRate * shiftFactor;
            const hourlyRate = effectiveDailyRate / pdfConfig.hoursPerDay;
            const empOvertimeHours = monthOvertime.filter(ot => ot.employeeId === emp.id).reduce((sum, curr) => sum + curr.hours, 0);
            const overtimePay = empOvertimeHours * hourlyRate * pdfConfig.otMultiplier;
            const empBonus = monthBonuses.filter(b => b.employeeId === emp.id).reduce((sum, curr) => sum + curr.amount, 0);
            const fixedTransportation = emp.transportationAllowance || 0;
            const extraTransportation = monthTransport.filter(t => t.employeeId === emp.id).reduce((sum, curr) => sum + curr.amount, 0);
            const totalTransportation = fixedTransportation + extraTransportation;
            const loan = loans.find(l => l.employeeId === emp.id);
            const loanDeduction = loan ? (loan.totalAmount * (loan.deductionPercentage / 100)) : 0;
            const totalAdvances = monthAdvances.filter(a => a.employeeId === emp.id).reduce((sum, curr) => sum + curr.amount, 0);
            const totalEarnings = earnedBasicWages + overtimePay + totalTransportation + empBonus;
            const totalDeductions = totalAdvances + loanDeduction;
            const netSalary = Math.max(0, totalEarnings - totalDeductions);

            return [
               emp.name,
               sectionName,
               emp.monthlyWage,
               emp.shift,
               daysAbsent,
               Math.round(totalAbsenceDeduction),
               empOvertimeHours,
               Math.round(overtimePay),
               empBonus,
               totalTransportation,
               totalAdvances,
               Math.round(loanDeduction),
               Math.round(netSalary)
            ].join(',');
         });

         const csvContent = '\uFEFF' + [headers.join(','), ...rows].join('\n');
         const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
         const link = document.createElement('a');
         link.href = URL.createObjectURL(blob);
         link.download = `Payroll_${targetMonth}.csv`;
         link.click();
      };

      return (
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 pb-20 relative">
          <div className="lg:col-span-2 space-y-6">
            <div className="flex bg-white p-1 rounded-2xl shadow-sm border border-gray-100 w-fit">
              <button onClick={() => setActiveTab('workers')} className={`px-6 py-2 rounded-xl text-xs font-black uppercase tracking-widest transition-all ${activeTab === 'workers' ? 'bg-indigo-600 text-white shadow-lg' : 'text-black hover:text-indigo-600'}`}>{t('workers')}</button>
              <button onClick={() => setActiveTab('sections')} className={`px-6 py-2 rounded-xl text-xs font-black uppercase tracking-widest transition-all ${activeTab === 'sections' ? 'bg-indigo-600 text-white shadow-lg' : 'text-black hover:text-indigo-600'}`}>{t('sections')}</button>
              <button onClick={() => setActiveTab('periods')} className={`px-6 py-2 rounded-xl text-xs font-black uppercase tracking-widest transition-all ${activeTab === 'periods' ? 'bg-indigo-600 text-white shadow-lg' : 'text-black hover:text-indigo-600'}`}>{t('periods')}</button>
            </div>
            
            {activeTab === 'workers' && (
              <section className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div className="px-6 py-4 border-b border-gray-100 bg-gray-50/50 flex flex-col md:flex-row md:items-center justify-between gap-4">
                  <div><h3 className="font-black text-black">{viewResigned ? t('resigned') : t('active')}</h3></div>
                  <div className="flex bg-gray-200 p-1 rounded-lg">
                    <button onClick={() => setViewResigned(false)} className={`px-3 py-1 rounded-md text-xs font-bold transition-all ${!viewResigned ? 'bg-white shadow-sm text-black' : 'text-black opacity-50'}`}>{t('active')}</button>
                    <button onClick={() => setViewResigned(true)} className={`px-3 py-1 rounded-md text-xs font-bold transition-all ${viewResigned ? 'bg-white shadow-sm text-black' : 'text-black opacity-50'}`}>{t('resigned')}</button>
                  </div>
                  <input type="text" placeholder={t('search')} className="block w-full md:w-48 px-3 py-2 border-2 border-gray-300 rounded-lg text-sm bg-white outline-none text-black font-bold" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} />
                </div>
                <div className="divide-y divide-gray-100">
                  {Object.entries(employeesBySection).map(([sId, emps]) => {
                    if (emps.length === 0 && sId !== 'unassigned') return null;
                    return (
                      <div key={sId} className="bg-white">
                        <div className="bg-gray-50/50 px-6 py-2 border-y border-gray-100 text-[10px] font-black text-black uppercase tracking-[0.2em]">{sId === 'unassigned' ? t('unassigned') : sections.find(s => s.id === sId)?.name || '???'}</div>
                        <div className="overflow-x-auto">
                           <table className="w-full text-left">
                             <tbody>
                               {emps.map(emp => (
                                 <React.Fragment key={emp.id}>
                                   <tr className="hover:bg-indigo-50/30 transition-colors border-b border-gray-50">
                                     <td className="px-4 py-4 w-10 text-center"><button onClick={() => setExpandedId(expandedId === emp.id ? null : emp.id)} className="text-black hover:text-indigo-600 font-bold text-lg">{expandedId === emp.id ? '-' : '+'}</button></td>
                                     <td className="px-6 py-4"><span className="font-black text-black">{emp.name}</span> <span className={`text-[8px] font-black uppercase px-1.5 py-0.5 rounded ${emp.shift === 'night' ? 'bg-black text-amber-400' : 'bg-amber-100 text-amber-700'}`}>{t(emp.shift || 'day')}</span></td>
                                     <td className="px-6 py-4 text-center font-black text-black">{emp.monthlyWage.toLocaleString()} {t('syp')}</td>
                                     <td className="px-6 py-4 text-center font-black text-black">
                                        {emp.transportationAllowance > 0 ? (
                                           <span className="text-green-600">{emp.transportationAllowance.toLocaleString()}</span>
                                        ) : (
                                           <span className="text-red-500 bg-red-50 px-2 py-1 rounded text-[10px] uppercase">{t('missing')}</span>
                                        )}
                                     </td>
                                     <td className="px-6 py-4 text-right">
                                       {!viewResigned && <button onClick={() => startEditing(emp)} className="text-indigo-600 font-black px-2 text-[10px] uppercase">{t('edit')}</button>}
                                       <button onClick={() => { setEmployeeTarget(emp); setShowDeleteModal(true); }} className="text-red-600 font-black px-2 text-[10px] uppercase">{t('delete')}</button>
                                     </td>
                                   </tr>
                                   {(expandedId === emp.id || editingId === emp.id) && (
                                     <tr className="bg-gray-50/80"><td colSpan={5} className="px-8 py-6">
                                       <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                          <div><label className="text-[10px] font-black uppercase block mb-1">{t('name')}</label>{editingId === emp.id ? <input className={inputClass} value={editFormData.name} onChange={e=>setEditFormData({...editFormData, name:e.target.value})} /> : <p className="font-black">{emp.name}</p>}</div>
                                          <div><label className="text-[10px] font-black uppercase block mb-1">{t('wage')}</label>{editingId === emp.id ? <input type="number" className={inputClass} value={editFormData.wage} onChange={e=>setEditFormData({...editFormData, wage:e.target.value})} /> : <p className="font-black">{emp.monthlyWage}</p>}</div>
                                          
                                          {/* Missing Fields Added Here for Editing */}
                                          <div><label className="text-[10px] font-black uppercase block mb-1">{t('fatherName')}</label>{editingId === emp.id ? <input className={inputClass} value={editFormData.fatherName} onChange={e=>setEditFormData({...editFormData, fatherName:e.target.value})} /> : <p className="font-black">{emp.fatherName || '-'}</p>}</div>
                                          <div><label className="text-[10px] font-black uppercase block mb-1">{t('motherName')}</label>{editingId === emp.id ? <input className={inputClass} value={editFormData.motherName} onChange={e=>setEditFormData({...editFormData, motherName:e.target.value})} /> : <p className="font-black">{emp.motherName || '-'}</p>}</div>
                                          <div><label className="text-[10px] font-black uppercase block mb-1">{t('nationalId')}</label>{editingId === emp.id ? <input className={inputClass} value={editFormData.nationalId} onChange={e=>setEditFormData({...editFormData, nationalId:e.target.value})} /> : <p className="font-black">{emp.nationalId || '-'}</p>}</div>
                                          <div><label className="text-[10px] font-black uppercase block mb-1">{t('insuranceId')}</label>{editingId === emp.id ? <input className={inputClass} value={editFormData.socialInsuranceId} onChange={e=>setEditFormData({...editFormData, socialInsuranceId:e.target.value})} /> : <p className="font-black">{emp.socialInsuranceId || '-'}</p>}</div>
                                          <div><label className="text-[10px] font-black uppercase block mb-1">{t('transport')}</label>{editingId === emp.id ? <input type="number" className={inputClass} value={editFormData.transportationAllowance} onChange={e=>setEditFormData({...editFormData, transportationAllowance:e.target.value})} /> : <p className="font-black">{emp.transportationAllowance || '0'}</p>}</div>

                                          {editingId === emp.id && <div className="col-span-full flex justify-end gap-2 mt-4"><button onClick={handleUpdate} className="bg-indigo-600 text-white px-6 py-2 rounded-lg font-black uppercase text-xs">{t('save')}</button><button onClick={()=>setEditingId(null)} className="bg-gray-200 text-black px-6 py-2 rounded-lg font-black uppercase text-xs">{t('cancel')}</button></div>}
                                       </div>
                                     </td></tr>
                                   )}
                                 </React.Fragment>
                               ))}
                             </tbody>
                           </table>
                        </div>
                      </div>
                    )
                  })}
                </div>
              </section>
            )}
            
            {activeTab === 'sections' && (
              <section className="bg-white rounded-xl shadow-sm border border-gray-100 p-8">
                <h3 className="text-xl font-black text-black uppercase mb-6">{t('sections')}</h3>
                <div className="flex gap-4 mb-6">
                  <input type="text" className="flex-1 px-4 py-3 border-2 border-gray-300 rounded-xl outline-none font-bold text-black" placeholder={t('name')} value={newSectionName} onChange={e => setNewSectionName(e.target.value)} />
                  <button onClick={() => { if(newSectionName) { addSection(newSectionName); setNewSectionName(''); }}} className="px-8 py-3 bg-indigo-600 text-white font-black rounded-xl uppercase text-[10px] tracking-widest">{t('add')}</button>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {sections.map(s => (
                    <div key={s.id} className="bg-gray-50 p-4 rounded-xl border border-gray-100 flex items-center justify-between">
                      <span className="font-black text-sm text-black">{s.name}</span>
                      <button onClick={() => deleteSection(s.id)} className="text-red-600 font-black">X</button>
                    </div>
                  ))}
                </div>
              </section>
            )}

            {/* NEW: Periods Tab for HR Locking */}
            {activeTab === 'periods' && (
               <section className="bg-white rounded-xl shadow-sm border border-gray-100 p-8">
                  <h3 className="text-xl font-black text-black uppercase mb-6">{t('payrollPeriods')}</h3>
                  <div className="space-y-4">
                     {recentMonths.map(month => {
                        const isLocked = lockedMonths.includes(month);
                        return (
                           <div key={month} className={`flex items-center justify-between p-5 rounded-2xl border-2 ${isLocked ? 'border-indigo-100 bg-indigo-50' : 'border-gray-100 bg-gray-50'}`}>
                              <div>
                                 <p className="text-lg font-black text-black">{month}</p>
                                 <p className={`text-[10px] font-black uppercase tracking-widest ${isLocked ? 'text-indigo-600' : 'text-gray-500'}`}>{isLocked ? t('closedLocked') : t('openForEdits')}</p>
                              </div>
                              {isLocked ? (
                                 <div className="flex gap-2">
                                    <button onClick={()=>handleExportCSV(month)} className="px-4 py-2 bg-green-600 text-white rounded-lg text-[10px] font-black uppercase tracking-widest hover:bg-green-700">{t('exportCsv')}</button>
                                    <button onClick={()=>handleGeneratePDF(month)} disabled={isGenerating} className="px-4 py-2 bg-indigo-600 text-white rounded-lg text-[10px] font-black uppercase tracking-widest hover:bg-indigo-700">{isGenerating ? '...' : t('generatePdf')}</button>
                                 </div>
                              ) : (
                                 <button onClick={() => lockPeriod(month)} className="px-6 py-3 bg-red-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg hover:bg-red-700 transition-all">
                                    {t('finalizeLock')}
                                 </button>
                              )}
                           </div>
                        );
                     })}
                  </div>
               </section>
            )}
          </div>
          <div className="space-y-6">
            <section className="bg-white rounded-xl shadow-sm border border-gray-100 p-6 sticky top-6">
              <h3 className="font-black text-black text-lg uppercase tracking-tight mb-6 flex items-center gap-2">
                 <div className="w-8 h-8 bg-indigo-50 rounded-lg flex items-center justify-center text-indigo-600 text-xl">+</div> {t('add')} {t('workers')}
              </h3>
              <form onSubmit={handleAdd} className="space-y-4">
                <input type="text" required className={inputClass} placeholder={t('name')} value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} />
                
                {/* Added Fields for Father, Mother, ID, Insurance */}
                <div className="grid grid-cols-2 gap-3">
                   <input type="text" className={inputClass} placeholder={t('fatherName')} value={formData.fatherName} onChange={e => setFormData({...formData, fatherName: e.target.value})} />
                   <input type="text" className={inputClass} placeholder={t('motherName')} value={formData.motherName} onChange={e => setFormData({...formData, motherName: e.target.value})} />
                </div>
                <div className="grid grid-cols-2 gap-3">
                   <input type="text" className={inputClass} placeholder={t('nationalId')} value={formData.nationalId} onChange={e => setFormData({...formData, nationalId: e.target.value})} />
                   <input type="text" className={inputClass} placeholder={t('insuranceId')} value={formData.socialInsuranceId} onChange={e => setFormData({...formData, socialInsuranceId: e.target.value})} />
                </div>
                
                <div className="grid grid-cols-2 gap-3">
                  <input type="number" required className={inputClass} placeholder={t('wage')} value={formData.wage} onChange={e => setFormData({...formData, wage: e.target.value})} />
                  <input type="number" required className={inputClass} placeholder={t('transport')} value={formData.transportAllowance} onChange={e => setFormData({...formData, transportAllowance: e.target.value})} />
                </div>
                <div className="grid grid-cols-2 gap-3">
                   <select className={inputClass} value={formData.shift} onChange={e => setFormData({...formData, shift: e.target.value})}><option value="day">{t('day')}</option><option value="night">{t('night')}</option></select>
                   <select className={inputClass} value={formData.sectionId} onChange={e => setFormData({...formData, sectionId: e.target.value})}><option value="">{t('unassigned')}</option>{sections.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}</select>
                </div>
                <button type="submit" className="w-full bg-indigo-600 text-white font-black py-4 rounded-xl shadow-xl hover:bg-indigo-700 transition-all uppercase tracking-widest text-xs mt-4">{t('confirm')}</button>
              </form>
            </section>
          </div>
          {showDeleteModal && (
            <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/50">
              <div className="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 text-center">
                <h4 className="text-xl font-black mb-2 text-red-600">{t('delete')}</h4>
                <p className="text-black text-sm mb-6">{t('eraseConfirm')} <span className="font-black underline">{employeeTarget?.name}</span>?</p>
                <div className="flex gap-3">
                  <button onClick={() => setShowDeleteModal(false)} className="flex-1 py-3 bg-gray-100 text-black font-black rounded-lg uppercase text-xs">{t('cancel')}</button>
                  <button onClick={() => { deleteEmployee(employeeTarget.id); setShowDeleteModal(false); }} className="flex-1 py-3 bg-red-600 text-white font-black rounded-lg uppercase text-xs">{t('delete')}</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    const ManagerDashboard = ({ employees, sections, attendance, advances, overtime, updateAttendance, addAdvance, addOvertime, lockedMonths, lang, t, canEdit, updateAdvance, updateOvertime, deleteAdvance, deleteOvertime }) => {
      const [selectedDate, setSelectedDate] = React.useState(new Date().toISOString().split('T')[0]);
      const [searchQuery, setSearchQuery] = React.useState('');
      const [activeTab, setActiveTab] = React.useState('attendance');
      const [advanceAmount, setAdvanceAmount] = React.useState({});
      const [otHours, setOtHours] = React.useState({});
      const [expandedSections, setExpandedSections] = React.useState({});
      const [editingEntries, setEditingEntries] = React.useState(null);
      
      const isLocked = lockedMonths.includes(selectedDate.substring(0, 7));
      const dailyRecord = attendance.find(a => a.date === selectedDate) || { date: selectedDate, absentEmployeeIds: [] };
      
      const dailyAdvances = advances.filter(a => a.date === selectedDate);
      const dailyOvertime = overtime.filter(o => o.date === selectedDate);

      const filteredEmployees = employees.filter(emp => !emp.isResigned && emp.name.toLowerCase().includes(searchQuery.toLowerCase()));
      const employeesBySection = React.useMemo(() => {
         const grouped = { 'unassigned': [] };
         sections.forEach(s => grouped[s.id] = []);
         filteredEmployees.forEach(emp => { if (emp.sectionId && grouped[emp.sectionId]) grouped[emp.sectionId].push(emp); else grouped['unassigned'].push(emp); });
         return grouped;
      }, [filteredEmployees, sections]);

      const sortedSectionIds = React.useMemo(() => {
         return Object.keys(employeesBySection).sort((a, b) => {
            if (a === 'unassigned') return 1; 
            if (b === 'unassigned') return -1;
            const nameA = sections.find(s => s.id === a)?.name || '';
            const nameB = sections.find(s => s.id === b)?.name || '';
            return nameA.localeCompare(nameB);
         });
      }, [employeesBySection, sections]);

      const toggleSection = (id) => setExpandedSections(prev => ({...prev, [id]: !prev[id]}));
      const toggleAbsence = (id) => { if(isLocked) return; const ids = dailyRecord.absentEmployeeIds.includes(id) ? dailyRecord.absentEmployeeIds.filter(x=>x!==id) : [...dailyRecord.absentEmployeeIds, id]; updateAttendance(selectedDate, ids); };
      const handleAddAdv = (id) => { if(isLocked) return; const val = parseFloat(advanceAmount[id]); if(val <= 0) return alert(t('mustBePositive')); addAdvance(id, val, selectedDate); setAdvanceAmount({...advanceAmount, [id]:''}); };
      const handleAddOT = (id) => { if(isLocked) return; const val = parseFloat(otHours[id]); if(val <= 0) return alert(t('mustBePositive')); addOvertime(id, val, selectedDate); setOtHours({...otHours, [id]:''}); };

      const saveAllAdvances = () => {
         if (isLocked) return;
         let count = 0;
         Object.entries(advanceAmount).forEach(([id, val]) => {
            const amount = parseFloat(val);
            if (amount > 0) { addAdvance(id, amount, selectedDate); count++; }
         });
         setAdvanceAmount({});
         if(count > 0) alert(`${count} advances saved successfully.`);
      };

      const saveAllOvertime = () => {
         if (isLocked) return;
         let count = 0;
         Object.entries(otHours).forEach(([id, val]) => {
            const hours = parseFloat(val);
            if (hours > 0) { addOvertime(id, hours, selectedDate); count++; }
         });
         setOtHours({});
         if(count > 0) alert(`${count} overtime records saved successfully.`);
      };

      const openEditModal = (empId, type) => {
         if(!canEdit) return;
         setEditingEntries({ empId, type });
      };

      const handleEditSave = (recordId, newVal) => {
         const val = parseFloat(newVal);
         if(val <= 0) return alert(t('mustBePositive'));
         if(editingEntries.type === 'advances') updateAdvance(recordId, val);
         else updateOvertime(recordId, val);
      };

      const handleEditDelete = (recordId) => {
         if(editingEntries.type === 'advances') deleteAdvance(recordId);
         else deleteOvertime(recordId);
      };

      return (
        <div className="max-w-6xl mx-auto space-y-6 pb-20 relative">
           <section className="bg-white rounded-3xl shadow-sm border border-gray-100 p-6 flex flex-col md:flex-row gap-6 items-center justify-between relative overflow-hidden">
             {isLocked && <div className="absolute top-0 right-0 px-6 py-1 bg-red-600 text-white text-[8px] font-black uppercase tracking-widest shadow-lg">{t('locked')}</div>}
             <div className="flex-1"><h2 className="text-xl font-black text-black tracking-tight uppercase">{t('opsHub')}</h2><p className="text-sm text-black font-black">{t('recordingFor')} <span className="text-indigo-600">{selectedDate}</span></p></div>
             <div className="flex flex-col sm:flex-row items-center gap-4 w-full md:w-auto">
                <input type="date" className="px-4 py-3 border-2 border-gray-300 rounded-2xl font-bold text-black bg-white" value={selectedDate} onChange={(e) => setSelectedDate(e.target.value)} />
                <div className="flex bg-gray-100 p-1 rounded-2xl">
                   {['attendance','advances','overtime'].map(m => <button key={m} onClick={()=>setActiveTab(m)} className={`px-4 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all ${activeTab === m ? 'bg-white text-indigo-600 shadow-sm' : 'text-black opacity-50 hover:opacity-100'}`}>{t(m)}</button>)}
                </div>
             </div>
           </section>
           
           <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
             <div className="lg:col-span-2 space-y-6">
                <section className="bg-white rounded-[2rem] shadow-sm border border-gray-100 overflow-hidden">
                   <div className="p-6 border-b border-gray-100 bg-gray-50/30 flex justify-between items-center">
                      <input type="text" placeholder={t('search')} className="w-full sm:w-80 py-4 bg-transparent border-b-2 border-gray-300 focus:border-indigo-600 outline-none font-bold text-black" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} />
                   </div>
                   <div className={`divide-y divide-gray-50 ${isLocked ? 'pointer-events-none opacity-50' : ''}`}>
                      {sortedSectionIds.map(sId => {
                         const emps = employeesBySection[sId];
                         if (emps.length === 0) return null;
                         const isExpanded = expandedSections[sId] !== false; 
                         return (
                            <div key={sId}>
                               <button onClick={() => toggleSection(sId)} className="w-full flex justify-between items-center bg-gray-100/50 px-8 py-3 text-[10px] font-black text-black uppercase tracking-[0.2em] hover:bg-gray-200/50 transition-colors">
                                  <span>{sId === 'unassigned' ? t('unassigned') : sections.find(s => s.id === sId)?.name}</span>
                                  <span className="text-xs font-bold text-gray-500">{isExpanded ? 'v' : '>'}</span>
                               </button>
                               {isExpanded && emps.map(emp => {
                                  const isAbsent = dailyRecord.absentEmployeeIds.includes(emp.id);
                                  const existingAdv = dailyAdvances.filter(a => a.employeeId === emp.id).reduce((sum, r) => sum + r.amount, 0);
                                  const existingOT = dailyOvertime.filter(o => o.employeeId === emp.id).reduce((sum, r) => sum + r.hours, 0);

                                  return (
                                     <div key={emp.id} className={`px-8 py-6 flex flex-col sm:flex-row sm:items-center justify-between gap-6 transition-all hover:bg-gray-50 ${isAbsent && activeTab==='attendance'?'bg-red-50/30':''}`}>
                                        <div className="flex items-center gap-5 flex-1"><div className={`w-14 h-14 rounded-[1.25rem] flex items-center justify-center font-black text-lg shadow-sm border-2 ${isAbsent && activeTab==='attendance' ? 'bg-red-100 text-red-600 border-red-200' : 'bg-indigo-50 text-indigo-600 border-indigo-100'}`}>{emp.name.charAt(0)}</div><div><p className={`font-black text-base ${isAbsent && activeTab==='attendance' ? 'text-red-700' : 'text-black'}`}>{emp.name}</p><p className="text-[11px] font-black uppercase opacity-60">{t(emp.shift)}</p></div></div>
                                        <div className="flex items-center gap-4 shrink-0">
                                           {activeTab === 'attendance' && (
                                              <button onClick={() => toggleAbsence(emp.id)} className={`w-12 h-12 rounded-2xl border-4 flex items-center justify-center transition-all ${isAbsent ? 'bg-red-600 border-red-200 text-white' : 'bg-white border-gray-100 text-black shadow-sm'}`}>
                                                 {isAbsent ? 'X' : '✓'}
                                              </button>
                                           )}
                                           {activeTab === 'advances' && !isAbsent && (
                                              <div className="flex flex-col items-end gap-1">
                                                 {existingAdv > 0 && <div className="flex items-center gap-2"><span className="text-[10px] font-black text-green-600 bg-green-50 px-2 py-0.5 rounded-lg">{t('logged')}: {existingAdv.toLocaleString()}</span>{canEdit && <button onClick={()=>openEditModal(emp.id, 'advances')} className="text-xs">✏️</button>}</div>}
                                                 <div className="flex gap-2"><input type="number" min="0" placeholder="0" className="w-24 px-3 py-2 font-bold text-black bg-white rounded-xl border-2 border-gray-300" value={advanceAmount[emp.id]||''} onChange={e => setAdvanceAmount({...advanceAmount, [emp.id]:e.target.value})} /><button onClick={() => handleAddAdv(emp.id)} className="px-4 py-2 bg-black text-white rounded-xl font-black uppercase text-[10px]">{t('add')}</button></div>
                                              </div>
                                           )}
                                           {activeTab === 'overtime' && !isAbsent && (
                                              <div className="flex flex-col items-end gap-1">
                                                 {existingOT > 0 && <div className="flex items-center gap-2"><span className="text-[10px] font-black text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded-lg">{t('logged')}: {existingOT}h</span>{canEdit && <button onClick={()=>openEditModal(emp.id, 'overtime')} className="text-xs">✏️</button>}</div>}
                                                 <div className="flex gap-2"><input type="number" min="0" placeholder="Hrs" className="w-20 px-3 py-2 font-bold text-black bg-white rounded-xl border-2 border-gray-300" value={otHours[emp.id]||''} onChange={e => setOtHours({...otHours, [emp.id]:e.target.value})} /><button onClick={() => handleAddOT(emp.id)} className="px-4 py-2 bg-indigo-600 text-white rounded-xl font-black uppercase text-[10px]">{t('add')}</button></div>
                                              </div>
                                           )}
                                        </div>
                                     </div>
                                  );
                               })}
                            </div>
                         );
                      })}
                   </div>
                </section>
             </div>
             <div className="space-y-6 lg:sticky lg:top-24">
                <section className="bg-white rounded-[2rem] shadow-sm border border-gray-100 p-8">
                   <h3 className="font-black text-black text-sm mb-6 flex items-center gap-3 uppercase tracking-widest"><div className="w-2 h-6 bg-indigo-600 rounded-full"></div>{t('activitySummary')}</h3>
                   <p className="text-xs text-gray-500 font-bold">{t('historyProtected')}</p>
                </section>
             </div>
           </div>

           {!isLocked && (activeTab === 'advances' || activeTab === 'overtime') && (
              <div className="fixed bottom-6 right-6 z-50 animate-bounce-in">
                 <button onClick={activeTab === 'advances' ? saveAllAdvances : saveAllOvertime} className="bg-black text-white px-8 py-4 rounded-full shadow-2xl font-black uppercase text-xs tracking-widest hover:scale-105 transition-transform flex items-center gap-3">
                    <span>{t('saveAll')} {activeTab === 'advances' ? t('advances') : t('overtime')}</span>
                    <div className="w-2 h-2 bg-green-400 rounded-full"></div>
                 </button>
              </div>
           )}

           {editingEntries && (
              <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
                 <div className="bg-white rounded-[2rem] shadow-2xl w-full max-w-md p-8 animate-in fade-in zoom-in duration-200">
                    <div className="flex justify-between items-center mb-6">
                       <h3 className="text-xl font-black uppercase">{t('editEntries')}</h3>
                       <button onClick={()=>setEditingEntries(null)} className="text-gray-400 hover:text-black">✕</button>
                    </div>
                    <div className="space-y-4 max-h-[60vh] overflow-y-auto">
                       {(editingEntries.type === 'advances' ? dailyAdvances : dailyOvertime)
                          .filter(x => x.employeeId === editingEntries.empId)
                          .map(record => (
                             <div key={record.id} className="flex gap-2 items-center">
                                <input className="flex-1 p-3 border-2 rounded-xl font-bold bg-gray-50" type="number" min="0" defaultValue={editingEntries.type === 'advances' ? record.amount : record.hours} onBlur={(e) => handleEditSave(record.id, e.target.value)} />
                                <button onClick={() => handleEditDelete(record.id)} className="bg-red-100 text-red-600 p-3 rounded-xl font-bold">🗑</button>
                             </div>
                          ))}
                    </div>
                    <button onClick={()=>setEditingEntries(null)} className="w-full mt-6 bg-black text-white py-4 rounded-xl font-black uppercase text-xs tracking-widest">{t('confirm')}</button>
                 </div>
              </div>
           )}
        </div>
      );
    };

    const FinanceDashboard = ({ employees, loans, advances, transportation, overtime, updateLoan, lockedMonths, lang, t }) => {
      const [searchQuery, setSearchQuery] = React.useState('');
      const [loanTarget, setLoanTarget] = React.useState(null);
      const [loanAmount, setLoanAmount] = React.useState('');
      const [loanPercent, setLoanPercent] = React.useState('10');

      const activeEmployees = employees.filter(emp => !emp.isResigned && emp.name.toLowerCase().includes(searchQuery.toLowerCase()));
      const handleSaveLoan = () => { if (loanTarget) { updateLoan(loanTarget.id, parseFloat(loanAmount), parseFloat(loanPercent)); setLoanTarget(null); }};

      return (
         <div className="space-y-8 max-w-7xl mx-auto pb-12">
            <header className="flex justify-between items-center">
               <div><h2 className="text-3xl font-black text-black uppercase">{t('liabilityOversight')}</h2></div>
               <input type="text" placeholder={t('name')} className="px-4 py-3 bg-white border border-gray-200 rounded-2xl outline-none font-black text-black w-72" value={searchQuery} onChange={e=>setSearchQuery(e.target.value)} />
            </header>
            <div className="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden">
               <table className="w-full text-left">
                  <thead className="bg-white text-[10px] uppercase font-black text-black tracking-widest border-b"><tr><th className="px-8 py-5">{t('employeeInfo')}</th><th className="px-8 py-5 text-center">{t('remainingDebt')}</th><th className="px-8 py-5 text-right">{t('actions')}</th></tr></thead>
                  <tbody className="divide-y divide-gray-100">
                     {activeEmployees.map(emp => {
                        const loan = loans.find(l => l.employeeId === emp.id);
                        return (
                           <tr key={emp.id} className="hover:bg-indigo-50/30">
                              <td className="px-8 py-6 font-black text-black">{emp.name}</td>
                              <td className="px-8 py-6 text-center">{loan ? `${loan.totalAmount.toLocaleString()} SYP` : '-'}</td>
                              <td className="px-8 py-6 text-right"><button onClick={() => { setLoanTarget(emp); setLoanAmount(loan?.totalAmount||''); setLoanPercent(loan?.deductionPercentage||'10'); }} className={`px-6 py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest ${loan ? 'bg-white text-black border-2 border-black' : 'bg-indigo-600 text-white'}`}>{loan ? t('editContract') : t('issueLoan')}</button></td>
                           </tr>
                        );
                     })}
                  </tbody>
               </table>
            </div>
            {loanTarget && (
               <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-gray-900/60 backdrop-blur-md">
                  <div className="bg-white rounded-[2.5rem] shadow-2xl max-w-md w-full p-10 space-y-6">
                     <h4 className="text-2xl font-black text-black uppercase">{t('liabilityContract')}</h4>
                     <p className="font-black uppercase text-xs">{t('managingProfile')} <span className="text-indigo-600 underline">{loanTarget.name}</span></p>
                     <div><label className="block text-[10px] font-black uppercase mb-2">{t('total')} ({t('syp')})</label><input type="number" className="w-full px-5 py-4 bg-gray-50 border-2 border-black rounded-2xl font-black text-xl text-black" value={loanAmount} onChange={e=>setLoanAmount(e.target.value)} /></div>
                     <div><label className="block text-[10px] font-black uppercase mb-2">{t('recoveryVelocity')} (%)</label><input type="number" className="w-full px-5 py-4 bg-gray-50 border-2 border-black rounded-2xl font-black text-xl text-black" value={loanPercent} onChange={e=>setLoanPercent(e.target.value)} /></div>
                     <div className="flex gap-4"><button onClick={()=>setLoanTarget(null)} className="flex-1 px-4 py-4 bg-gray-100 text-black font-black rounded-2xl uppercase text-[10px]">{t('discard')}</button><button onClick={handleSaveLoan} className="flex-1 px-4 py-4 bg-black text-white font-black rounded-2xl uppercase text-[10px]">{t('saveContract')}</button></div>
                  </div>
               </div>
            )}
         </div>
      );
    };

    const OwnerDashboard = ({ config, setConfig, lockedMonths, toggleMonthLock, attendance, employees, bonuses, addBonus, deleteBonus, users, addUser, updateUser, deleteUser, currentUser, lang, t }) => {
      const [activeOwnerTab, setActiveOwnerTab] = React.useState('logic');
      const [tempConfig, setTempConfig] = React.useState(config);
      const [newUserFormData, setNewUserFormData] = React.useState({ username: '', password: '', role: 'hr' });
      const [editingUserId, setEditingUserId] = React.useState(null);
      
      // Bonus Engine State
      const [bonusType, setBonusType] = React.useState('fixed'); // 'fixed' | 'percent'
      const [bonusTarget, setBonusTarget] = React.useState('individual'); // 'individual' | 'all'
      const [selectedBonusEmp, setSelectedBonusEmp] = React.useState('');
      const [bonusValue, setBonusValue] = React.useState(''); // Amount or Percentage
      const [bonusDesc, setBonusDesc] = React.useState('');
      
      const inputClass = "w-full px-4 py-3 bg-white border-2 border-gray-300 rounded-xl font-bold text-black outline-none focus:border-indigo-600 transition-all";
      const handleSave = () => { setConfig(tempConfig); alert(t('logicSync')); };
      
      const handleUserSubmit = (e) => { 
        e.preventDefault(); 
        if (editingUserId) {
          updateUser(editingUserId, newUserFormData);
          setEditingUserId(null);
        } else {
          addUser(newUserFormData); 
        }
        setNewUserFormData({ username: '', password: '', role: 'hr' }); 
      };

      const startEditUser = (user) => {
        setEditingUserId(user.id);
        setNewUserFormData({ username: user.username, password: user.password, role: user.role });
      };

      const cancelEditUser = () => {
        setEditingUserId(null);
        setNewUserFormData({ username: '', password: '', role: 'hr' });
      };
      
      const handleDistributeBonus = (e) => {
        e.preventDefault();
        const date = new Date().toISOString().split('T')[0];
        const val = parseFloat(bonusValue);
        if (!val || !bonusDesc) return;

        if (bonusTarget === 'all') {
          const activeEmps = employees.filter(e => !e.isResigned);
          activeEmps.forEach(emp => {
             const amount = bonusType === 'percent' ? (emp.monthlyWage * val / 100) : val;
             addBonus(emp.id, amount, date, bonusDesc);
          });
          alert(`Distributed bonus to ${activeEmps.length} employees.`);
        } else {
           if(!selectedBonusEmp) return;
           const emp = employees.find(e => e.id === selectedBonusEmp);
           if(emp) {
              const amount = bonusType === 'percent' ? (emp.monthlyWage * val / 100) : val;
              addBonus(emp.id, amount, date, bonusDesc);
           }
        }
        setBonusValue('');
        setBonusDesc('');
      };

      return (
        <div className="max-w-6xl mx-auto space-y-8 animate-in fade-in duration-500">
           <header className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
              <h2 className="text-4xl font-black text-black uppercase">{t('strategicControl')}</h2>
              <div className="flex bg-white p-1 rounded-2xl shadow-sm border border-gray-100 flex-wrap">
                 {['logic','periods','bonuses','users'].map(tab => <button key={tab} onClick={() => setActiveOwnerTab(tab)} className={`px-5 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all ${activeOwnerTab === tab ? 'bg-indigo-600 text-white shadow-lg' : 'text-black'}`}>{t(tab === 'logic' ? 'systemLogic' : tab === 'users' ? 'userAccess' : tab === 'bonuses' ? 'bonusCenter' : tab)}</button>)}
              </div>
           </header>
           
           {activeOwnerTab === 'logic' && (
              <div className="bg-white rounded-[2rem] shadow-xl border border-gray-50 p-8 space-y-6">
                 <h3 className="text-xl font-black text-black uppercase tracking-tight">{t('systemVariables')}</h3>
                 <div className="grid grid-cols-2 gap-4">
                    <div><label className="block text-[10px] font-black uppercase mb-2">{t('daysPerMonth')}</label><input type="number" className={inputClass} value={tempConfig.daysInMonth} onChange={e => setTempConfig({...tempConfig, daysInMonth: +e.target.value})} /></div>
                    <div><label className="block text-[10px] font-black uppercase mb-2">{t('hoursPerDay')}</label><input type="number" className={inputClass} value={tempConfig.hoursPerDay} onChange={e => setTempConfig({...tempConfig, hoursPerDay: +e.target.value})} /></div>
                    <div><label className="block text-[10px] font-black uppercase mb-2">{t('otFactor')}</label><input type="number" step="0.1" className={inputClass} value={tempConfig.otMultiplier} onChange={e => setTempConfig({...tempConfig, otMultiplier: +e.target.value})} /></div>
                    <div><label className="block text-[10px] font-black uppercase mb-2">{t('nightMultiplier')}</label><input type="number" step="0.1" className={inputClass} value={tempConfig.nightShiftMultiplier} onChange={e => setTempConfig({...tempConfig, nightShiftMultiplier: +e.target.value})} /></div>
                    <div><label className="block text-[10px] font-black uppercase mb-2 text-red-600">{t('absencePenalty')}</label><input type="number" step="0.1" className={inputClass} value={tempConfig.absentDeductionFactor} onChange={e => setTempConfig({...tempConfig, absentDeductionFactor: +e.target.value})} /></div>
                 </div>
                 <button onClick={handleSave} className="w-full bg-black text-white font-black py-4 rounded-2xl shadow-xl uppercase text-[10px] tracking-widest">{t('commitLogic')}</button>
              </div>
           )}

           {activeOwnerTab === 'periods' && (
              <div className="bg-white rounded-[2rem] shadow-xl border border-gray-50 p-8">
                 <h3 className="text-xl font-black uppercase mb-6">{t('payrollPeriods')}</h3>
                 <div className="space-y-3">
                    {[...new Set([...attendance.map(a=>a.date.substring(0,7)), ...lockedMonths])].sort().reverse().map(m => (
                       <div key={m} className={`p-4 rounded-2xl border-2 flex items-center justify-between ${lockedMonths.includes(m)?'bg-red-50 border-red-600':'bg-green-50 border-green-600'}`}>
                          <span className="font-black text-black">{m}</span>
                          <button onClick={()=>toggleMonthLock(m)} className="w-10 h-10 rounded-xl bg-white border-2 border-black flex items-center justify-center font-bold">{lockedMonths.includes(m)?'L':'U'}</button>
                       </div>
                    ))}
                 </div>
              </div>
           )}

           {activeOwnerTab === 'bonuses' && (
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                 <div className="bg-white rounded-[2rem] shadow-xl p-8">
                    <h3 className="text-xl font-black uppercase mb-6">{t('bonusEngine')}</h3>
                    <form onSubmit={handleDistributeBonus} className="space-y-4">
                        {/* Target Selection */}
                        <div>
                           <label className="block text-[10px] font-black uppercase mb-2">{t('target')}</label>
                           <div className="flex bg-gray-100 p-1 rounded-xl">
                              <button type="button" onClick={()=>setBonusTarget('individual')} className={`flex-1 py-2 rounded-lg text-[10px] font-black uppercase transition-all ${bonusTarget==='individual'?'bg-white shadow text-black':'text-gray-400'}`}>{t('individual')}</button>
                              <button type="button" onClick={()=>setBonusTarget('all')} className={`flex-1 py-2 rounded-lg text-[10px] font-black uppercase transition-all ${bonusTarget==='all'?'bg-white shadow text-indigo-600':'text-gray-400'}`}>{t('allActive')}</button>
                           </div>
                        </div>

                        {/* Distribution Type */}
                        <div>
                           <label className="block text-[10px] font-black uppercase mb-2">{t('distType')}</label>
                           <div className="flex bg-gray-100 p-1 rounded-xl">
                              <button type="button" onClick={()=>setBonusType('fixed')} className={`flex-1 py-2 rounded-lg text-[10px] font-black uppercase transition-all ${bonusType==='fixed'?'bg-white shadow text-black':'text-gray-400'}`}>{t('fixedAmount')}</button>
                              <button type="button" onClick={()=>setBonusType('percent')} className={`flex-1 py-2 rounded-lg text-[10px] font-black uppercase transition-all ${bonusType==='percent'?'bg-white shadow text-indigo-600':'text-gray-400'}`}>{t('percentWage')}</button>
                           </div>
                        </div>

                        {bonusTarget === 'individual' && (
                           <select className={inputClass} value={selectedBonusEmp} onChange={e=>setSelectedBonusEmp(e.target.value)} required={bonusTarget==='individual'}>
                              <option value="">Select Employee</option>
                              {employees.filter(e=>!e.isResigned).map(e=><option key={e.id} value={e.id}>{e.name}</option>)}
                           </select>
                        )}

                        <input className={inputClass} type="number" placeholder={bonusType === 'fixed' ? 'Amount (SYP)' : 'Percentage (%)'} value={bonusValue} onChange={e=>setBonusValue(e.target.value)} required />
                        <input className={inputClass} placeholder="Reason / Description" value={bonusDesc} onChange={e=>setBonusDesc(e.target.value)} required />
                        
                        <button className="w-full bg-indigo-600 text-white font-black py-4 rounded-xl uppercase text-xs tracking-widest shadow-xl hover:bg-indigo-700 transition-all">{t('distributeCapital')}</button>
                    </form>
                 </div>
                 <div className="bg-white rounded-[2rem] shadow-xl p-8 max-h-[500px] overflow-y-auto">
                    <h3 className="text-xl font-black uppercase mb-6">{t('distributionLogs')}</h3>
                    {bonuses.length === 0 && <p className="text-center text-gray-400 font-bold text-xs py-10">No records found.</p>}
                    {bonuses.map(b => (
                       <div key={b.id} className="flex justify-between items-center p-3 border-b hover:bg-gray-50 transition-colors">
                          <div><p className="font-black">{employees.find(e=>e.id===b.employeeId)?.name || 'Unknown'}</p><p className="text-[10px] font-bold text-gray-400 uppercase">{b.description} • {b.amount.toLocaleString()} SYP</p></div>
                          <button onClick={()=>deleteBonus(b.id)} className="text-red-500 font-black text-[10px] uppercase hover:bg-red-50 px-2 py-1 rounded">{t('delete')}</button>
                       </div>
                    ))}
                 </div>
              </div>
           )}

           {activeOwnerTab === 'users' && (
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                 <div className="bg-white rounded-[2rem] shadow-xl p-8">
                    <h3 className="text-xl font-black uppercase mb-6">{t('credentialManagement')}</h3>
                    {users.map(u => (
                       <div key={u.id} className="flex justify-between items-center p-4 border-b">
                          <span className="font-black">{u.username} <span className="bg-indigo-100 px-2 rounded text-xs uppercase text-indigo-600">{u.role}</span></span>
                          <div className="flex gap-2">
                             <button onClick={()=>startEditUser(u)} className="text-indigo-600 font-black text-xs uppercase hover:bg-indigo-50 px-2 py-1 rounded">{t('edit')}</button>
                             {u.id !== currentUser.id && <button onClick={()=>deleteUser(u.id)} className="text-red-600 font-black text-xs uppercase hover:bg-red-50 px-2 py-1 rounded">{t('delete')}</button>}
                          </div>
                       </div>
                    ))}
                 </div>
                 <div className="bg-white rounded-[2rem] shadow-xl p-8 h-fit">
                    <h3 className="text-xl font-black uppercase mb-6">{editingUserId ? t('updateIdentity') : t('createAccess')}</h3>
                    <form onSubmit={handleUserSubmit} className="space-y-4">
                       <input className={inputClass} placeholder={t('username')} value={newUserFormData.username} onChange={e=>setNewUserFormData({...newUserFormData, username:e.target.value})} required />
                       <input className={inputClass} placeholder={t('secretKey')} value={newUserFormData.password} onChange={e=>setNewUserFormData({...newUserFormData, password:e.target.value})} required />
                       <select className={inputClass} value={newUserFormData.role} onChange={e=>setNewUserFormData({...newUserFormData, role:e.target.value})}><option value="hr">HR</option><option value="manager">Manager</option><option value="finance">Finance</option><option value="data_entry">Data Entry</option><option value="owner">Owner</option></select>
                       
                       <div className="flex gap-2">
                          {editingUserId && <button type="button" onClick={cancelEditUser} className="flex-1 bg-gray-200 text-black p-4 rounded-xl font-black uppercase text-xs tracking-widest">{t('cancel')}</button>}
                          <button className="flex-1 bg-black text-white p-4 rounded-xl font-black uppercase text-xs tracking-widest">{editingUserId ? t('commit') : t('authorizeIdentity')}</button>
                       </div>
                    </form>
                 </div>
              </div>
           )}
        </div>
      );
    };

    // --- 5. MAIN APP (FIREBASE INTEGRATION) ---
    const App = () => {
      const [currentUser, setCurrentUser] = React.useState(null);
      const [lang, setLang] = React.useState(localStorage.getItem('sa_lang') || 'en');
      const [users, setUsers] = React.useState([]);
      const [employees, setEmployees] = React.useState([]);
      const [sections, setSections] = React.useState([]);
      const [attendance, setAttendance] = React.useState([]);
      const [advances, setAdvances] = React.useState([]);
      const [bonuses, setBonuses] = React.useState([]);
      const [overtime, setOvertime] = React.useState([]);
      const [transportation, setTransportation] = React.useState([]);
      const [loans, setLoans] = React.useState([]);
      const [lockedMonths, setLockedMonths] = React.useState([]);
      const [pdfConfig, setPdfConfig] = React.useState({ companyName: 'SalaryMaster', footerText: 'System Generated', logoPlaceholder: 'S|M', otMultiplier: 1.5, daysInMonth: 26, hoursPerDay: 8, absentDeductionFactor: 1.0, nightShiftMultiplier: 1.0 });

      const t = (key) => translations[key]?.[lang] || key;
      const toggleLanguage = () => { const l = lang === 'en' ? 'ar' : 'en'; setLang(l); localStorage.setItem('sa_lang', l); };

      React.useEffect(() => {
        const subs = [
          db.collection('users').onSnapshot(s => setUsers(s.docs.map(d => ({id:d.id, ...d.data()})))),
          db.collection('employees').onSnapshot(s => setEmployees(s.docs.map(d => ({id:d.id, ...d.data()})))),
          db.collection('sections').onSnapshot(s => setSections(s.docs.map(d => ({id:d.id, ...d.data()})))),
          db.collection('attendance').onSnapshot(s => setAttendance(s.docs.map(d => ({id:d.id, ...d.data()})))),
          db.collection('advances').onSnapshot(s => setAdvances(s.docs.map(d => ({id:d.id, ...d.data()})))),
          db.collection('bonuses').onSnapshot(s => setBonuses(s.docs.map(d => ({id:d.id, ...d.data()})))),
          db.collection('overtime').onSnapshot(s => setOvertime(s.docs.map(d => ({id:d.id, ...d.data()})))),
          db.collection('transportation').onSnapshot(s => setTransportation(s.docs.map(d => ({id:d.id, ...d.data()})))),
          db.collection('loans').onSnapshot(s => setLoans(s.docs.map(d => ({id:d.id, ...d.data()})))),
          db.collection('meta').doc('config').onSnapshot(d => d.exists && setPdfConfig(d.data())),
          db.collection('meta').doc('locks').onSnapshot(d => d.exists && setLockedMonths(d.data().months || []))
        ];
        // Create Default Owner if Empty
        db.collection('users').limit(1).get().then(s => { if(s.empty) db.collection('users').add({username:'owner', password:'123', role:'owner'}); });
        return () => subs.forEach(u => u());
      }, []);

      // Auto-Sync Current User if Updated Remotely (e.g. self-edit)
      React.useEffect(() => {
         if (currentUser) {
            const freshUser = users.find(u => u.id === currentUser.id);
            if (freshUser && JSON.stringify(freshUser) !== JSON.stringify(currentUser)) {
               setCurrentUser(freshUser);
            }
         }
      }, [users, currentUser]);

      if (!currentUser) return <Login onLogin={setCurrentUser} users={users} lang={lang} t={t} toggleLanguage={toggleLanguage} />;

      const renderDashboard = () => {
         // FIX: Pass config as BOTH 'pdfConfig' (for HR) and 'config' (for Owner/Manager) to prevent crashes
         const props = { 
            employees, sections, attendance, advances, bonuses, overtime, transportation, loans, 
            pdfConfig, config: pdfConfig, 
            lockedMonths, lang, t 
         };
         
         if (currentUser.role === 'owner') return <OwnerDashboard {...props} currentUser={currentUser} users={users} 
            setConfig={(c)=>db.collection('meta').doc('config').set(c)} 
            addUser={(u)=>db.collection('users').add(u)} 
            updateUser={(id, u)=>db.collection('users').doc(id).update(u)}
            deleteUser={(id)=>db.collection('users').doc(id).delete()} 
            addBonus={(eid, amt, date, desc) => db.collection('bonuses').add({employeeId: eid, amount: amt, date, description: desc})}
            deleteBonus={(id) => db.collection('bonuses').doc(id).delete()}
            toggleMonthLock={(m)=>{ const l = lockedMonths.includes(m)?lockedMonths.filter(x=>x!==m):[...lockedMonths,m]; db.collection('meta').doc('locks').set({months:l}); }} 
         />;
         if (currentUser.role === 'hr') return <HRDashboard {...props} lockPeriod={(m)=>{ if(!lockedMonths.includes(m)) db.collection('meta').doc('locks').set({months:[...lockedMonths, m]}); }} setPdfConfig={(c)=>db.collection('meta').doc('config').set(c)} addEmployee={(d)=>db.collection('employees').add(d)} updateEmployee={(id,d)=>db.collection('employees').doc(id).update(d)} deleteEmployee={(id)=>db.collection('employees').doc(id).delete()} addSection={(n)=>db.collection('sections').add({name:n})} deleteSection={(id)=>db.collection('sections').doc(id).delete()} />;
         // MANAGER ROUTING: Pass canEdit based on sub-role
         if (currentUser.role === 'manager' || currentUser.role === 'data_entry') {
            return <ManagerDashboard {...props} 
               canEdit={currentUser.role === 'manager'}
               updateAttendance={(d, ids) => { const r = attendance.find(a=>a.date===d); if(r) db.collection('attendance').doc(r.id).update({absentEmployeeIds:ids}); else db.collection('attendance').add({date:d, absentEmployeeIds:ids}); }} 
               addAdvance={(eid, amt, d)=>db.collection('advances').add({employeeId:eid, amount:amt, date:d})} 
               addOvertime={(eid, hrs, d)=>db.collection('overtime').add({employeeId:eid, hours:hrs, date:d})} 
               updateAdvance={(id, val)=>db.collection('advances').doc(id).update({amount:val})}
               updateOvertime={(id, val)=>db.collection('overtime').doc(id).update({hours:val})}
               deleteAdvance={(id)=>db.collection('advances').doc(id).delete()}
               deleteOvertime={(id)=>db.collection('overtime').doc(id).delete()}
            />;
         }
         if (currentUser.role === 'finance') return <FinanceDashboard {...props} updateLoan={(eid, tot, pct) => { const l = loans.find(x=>x.employeeId===eid); if(tot<=0 && l) db.collection('loans').doc(l.id).delete(); else if(l) db.collection('loans').doc(l.id).update({totalAmount:tot, deductionPercentage:pct}); else db.collection('loans').add({employeeId:eid, totalAmount:tot, deductionPercentage:pct}); }} />;
         return <div className="text-center p-10 font-black">{t('unauthorized')}</div>;
      };

      return (
         <div className={`min-h-screen flex flex-col ${lang === 'ar' ? 'font-arabic' : ''}`} dir={lang === 'ar' ? 'rtl' : 'ltr'}>
            <header className="bg-white/80 backdrop-blur-md shadow-sm px-6 py-4 flex justify-between items-center border-b border-slate-100 sticky top-0 z-50">
               <div><h1 className="text-2xl font-black text-indigo-600 tracking-tight">{t('appTitle')}</h1><p className="text-[10px] text-black font-black uppercase tracking-widest opacity-40">{t('subTitle')}</p></div>
               <div className="flex items-center gap-4">
                  <button onClick={toggleLanguage} className="px-3 py-1 bg-indigo-50 text-indigo-600 rounded-lg text-xs font-black border border-indigo-100 uppercase tracking-widest hover:bg-indigo-100 transition-colors">{lang === 'en' ? 'العربية' : 'English'}</button>
                  <div className="text-right hidden sm:block"><p className="text-sm font-black text-gray-800">{currentUser.username}</p><p className="text-[10px] uppercase font-black text-indigo-400 tracking-widest">{t(currentUser.role).toUpperCase()}</p></div>
                  <button onClick={() => setCurrentUser(null)} className="px-5 py-2.5 bg-gray-50 hover:bg-red-50 hover:text-red-600 text-gray-500 rounded-2xl text-xs font-black transition-all border border-gray-100 uppercase tracking-widest">{t('signOut')}</button>
               </div>
            </header>
            <main className="flex-1 p-6 max-w-7xl mx-auto w-full animate-in fade-in duration-700">{renderDashboard()}</main>
            <footer className="bg-white border-t p-6 text-center text-black text-[10px] font-black uppercase tracking-[0.2em]"><p className="mb-1">&copy; {new Date().getFullYear()} {pdfConfig.companyName}</p><p className="opacity-30">Industrial Operations Protocol v3.1</p></footer>
         </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
